<!-- templates/predict.html -->
{% extends "base.html" %} {% block title %}Risk Prediction - MedPredict AI{%
endblock %} {% block content %}
<div class="row mb-4">
  <div class="col-12">
    <h2 class="text-white mb-0">
      <i class="fas fa-calculator me-2"></i>Patient Risk Prediction
    </h2>
    <p class="text-white opacity-75">
      Enter patient data for AI-powered readmission risk assessment
    </p>
  </div>
</div>

<div class="row justify-content-center">
  <div class="col-lg-8">
    <div class="card">
      <div class="card-header">
        <h5 class="card-title mb-0">
          <i class="fas fa-user-md me-2"></i>Patient Information Form
        </h5>
      </div>
      <div class="card-body">
        <form method="POST" action="/predict" id="prediction-form">
          <div class="row">
            <!-- Patient Details -->
            <div class="col-12">
              <h6 class="text-primary mb-3">
                <i class="fas fa-user me-1"></i>Patient Details
              </h6>
            </div>

            <div class="col-md-6 mb-3">
              <label for="patient_id" class="form-label">Patient ID *</label>
              <input
                type="text"
                class="form-control"
                id="patient_id"
                name="patient_id"
                required
              />
            </div>

            <div class="col-md-6 mb-3">
              <label for="age" class="form-label">Age *</label>
              <input
                type="number"
                class="form-control"
                id="age"
                name="age"
                min="1"
                max="120"
                required
              />
            </div>

            <div class="col-md-6 mb-3">
              <label for="gender" class="form-label">Gender *</label>
              <select class="form-select" id="gender" name="gender" required>
                <option value="">Select Gender</option>
                <option value="Male">Male</option>
                <option value="Female">Female</option>
                <option value="Other">Other</option>
              </select>
            </div>

            <div class="col-md-6 mb-3">
              <label for="bmi" class="form-label">BMI *</label>
              <input
                type="number"
                class="form-control"
                id="bmi"
                name="bmi"
                step="0.1"
                min="10"
                max="60"
                required
              />
              <div class="form-text">Body Mass Index (kg/m²)</div>
            </div>

            <!-- Clinical Parameters -->
            <div class="col-12 mt-3">
              <hr />
              <h6 class="text-primary mb-3">
                <i class="fas fa-stethoscope me-1"></i>Clinical Parameters
              </h6>
            </div>

            <div class="col-md-6 mb-3">
              <label for="blood_pressure" class="form-label"
                >Blood Pressure *</label
              >
              <input
                type="text"
                class="form-control"
                id="blood_pressure"
                name="blood_pressure"
                pattern="[0-9]+/[0-9]+"
                placeholder="120/80"
                required
              />
              <div class="form-text">
                Format: Systolic/Diastolic (e.g., 120/80)
              </div>
            </div>

            <div class="col-md-6 mb-3">
              <label for="cholesterol" class="form-label"
                >Cholesterol Level *</label
              >
              <input
                type="number"
                class="form-control"
                id="cholesterol"
                name="cholesterol"
                step="0.1"
                min="50"
                max="500"
                required
              />
              <div class="form-text">mg/dL</div>
            </div>

            <div class="col-md-6 mb-3">
              <label for="diabetes" class="form-label">Diabetes *</label>
              <select
                class="form-select"
                id="diabetes"
                name="diabetes"
                required
              >
                <option value="">Select Option</option>
                <option value="Yes">Yes</option>
                <option value="No">No</option>
              </select>
            </div>

            <div class="col-md-6 mb-3">
              <label for="hypertension" class="form-label"
                >Hypertension *</label
              >
              <select
                class="form-select"
                id="hypertension"
                name="hypertension"
                required
              >
                <option value="">Select Option</option>
                <option value="Yes">Yes</option>
                <option value="No">No</option>
              </select>
            </div>

            <!-- Hospital Stay -->
            <div class="col-12 mt-3">
              <hr />
              <h6 class="text-primary mb-3">
                <i class="fas fa-hospital me-1"></i>Hospital Stay Information
              </h6>
            </div>

            <div class="col-md-6 mb-3">
              <label for="length_of_stay" class="form-label"
                >Length of Stay *</label
              >
              <input
                type="number"
                class="form-control"
                id="length_of_stay"
                name="length_of_stay"
                min="1"
                max="100"
                required
              />
              <div class="form-text">Days</div>
            </div>

            <div class="col-md-6 mb-3">
              <label for="medication_count" class="form-label"
                >Medication Count *</label
              >
              <input
                type="number"
                class="form-control"
                id="medication_count"
                name="medication_count"
                min="0"
                max="50"
                required
              />
              <div class="form-text">Number of medications prescribed</div>
            </div>

            <div class="col-12 mb-3">
              <label for="discharge_destination" class="form-label"
                >Discharge Destination *</label
              >
              <select
                class="form-select"
                id="discharge_destination"
                name="discharge_destination"
                required
              >
                <option value="">Select Destination</option>
                <option value="Home">Home</option>
                <option value="Nursing_Facility">Nursing Facility</option>
                <option value="Rehab">Rehabilitation Center</option>
                <option value="Other">Other</option>
              </select>
            </div>

            <!-- Doctor Info -->
            <div class="col-12 mt-3">
              <hr />
              <h6 class="text-primary mb-3">
                <i class="fas fa-user-md me-1"></i>Doctor Information
              </h6>
            </div>

            <div class="col-md-6 mb-3">
              <label for="doctor_name" class="form-label">Doctor Name *</label>
              <input
                type="text"
                class="form-control"
                id="doctor_name"
                name="doctor_name"
                required
              />
            </div>

            <div class="col-md-6 mb-3">
              <label for="doctor_email" class="form-label">Doctor Email</label>
              <input
                type="email"
                class="form-control"
                id="doctor_email"
                name="doctor_email"
              />
              <div class="form-text">Optional - for email notifications</div>
            </div>
          </div>

          <div class="row mt-4">
            <div class="col-12 text-center">
              <button type="submit" class="btn btn-gradient btn-lg">
                <span class="btn-text">
                  <i class="fas fa-brain me-2"></i>Predict Risk
                </span>
                <span
                  class="loading-spinner spinner-border spinner-border-sm me-2"
                  style="display: none"
                ></span>
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>

    <!-- ✅ Prediction Result -->
    {% if prediction %}
    <div class="alert alert-info mt-4 text-center">
      <h5>
        <i class="fas fa-chart-line me-2"></i>Prediction Result:
        <strong>{{ prediction }}</strong> Risk
      </h5>
    </div>
    {% endif %}

    <!-- ✅ Clinical Recommendations -->
    <div id="recommendations-section" class="mt-4" style="display: none">
      <h5 class="text-primary mb-3">
        <i class="fas fa-notes-medical me-2"></i> Clinical Recommendations
      </h5>
      <div class="card">
        <div class="card-body">
          <ul
            id="recommendations-list"
            class="list-group list-group-flush"
          ></ul>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- BMI Calculator Modal -->
<div class="modal fade" id="bmiModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">BMI Calculator</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-6">
            <label class="form-label">Weight (kg)</label>
            <input type="number" class="form-control" id="weight" step="0.1" />
          </div>
          <div class="col-6">
            <label class="form-label">Height (cm)</label>
            <input type="number" class="form-control" id="height" step="0.1" />
          </div>
        </div>
        <div class="text-center mt-3">
          <button class="btn btn-primary" onclick="calculateBMI()">
            Calculate BMI
          </button>
          <div id="bmi-result" class="mt-2"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Floating BMI Calculator Button -->
<button
  class="floating-action-btn"
  data-bs-toggle="modal"
  data-bs-target="#bmiModal"
  title="BMI Calculator"
>
  <i class="fas fa-calculator"></i>
</button>
{% endblock %} {% block scripts %}
<script>
  // BMI Calculator
  function calculateBMI() {
    const weight = document.getElementById("weight").value;
    const height = document.getElementById("height").value;

    if (weight && height) {
      const bmi = (weight / (height / 100) ** 2).toFixed(1);
      document.getElementById("bmi-result").innerHTML = `
            <div class="alert alert-info">
                <strong>BMI: ${bmi}</strong><br>
                <button class="btn btn-sm btn-success mt-1" onclick="useBMI(${bmi})">Use This BMI</button>
            </div>
        `;
    }
  }

  function useBMI(bmi) {
    document.getElementById("bmi").value = bmi;
    bootstrap.Modal.getInstance(document.getElementById("bmiModal")).hide();
  }

  function showLoading(btn) {
    btn.disabled = true;
    btn.querySelector(".btn-text").textContent = "Predicting...";
    btn.querySelector(".loading-spinner").style.display = "inline-block";
  }

  document.getElementById("prediction-form").addEventListener("submit", function (e) {
    const bp = document.getElementById("blood_pressure").value;
    const bpRegex = /^\d+\/\d+$/;

    if (!bpRegex.test(bp)) {
      e.preventDefault();
      alert("Please enter blood pressure in the correct format (e.g., 120/80)");
      document.getElementById("blood_pressure").focus();
      return;
    }

    const submitBtn = document.querySelector('button[type="submit"]');
    showLoading(submitBtn);
  });

  document.getElementById("bmi").addEventListener("input", function () {
    const bmi = parseFloat(this.value);
    let category = "";
    let color = "";

    if (bmi < 18.5) {
      category = "Underweight";
      color = "text-info";
    } else if (bmi < 25) {
      category = "Normal";
      color = "text-success";
    } else if (bmi < 30) {
      category = "Overweight";
      color = "text-warning";
    } else if (bmi >= 30) {
      category = "Obese";
      color = "text-danger";
    }

    if (category) {
      this.nextElementSibling.innerHTML = `BMI Category: <span class="${color}">${category}</span>`;
    }
  });

  // ✅ Clinical Recommendations
  const MEASURES = {
  "High": [
    "Telehealth within 48 hours",
    "Home nurse call within 72 hours",
    "Medication reconciliation & pillbox setup",
    "Early labs & vitals review",
    "Care coordinator & social support outreach"
  ],
  "Medium": [
    "Phone check 5–7 days post-discharge",
    "Pharmacist medication review",
    "Dietician counseling for risk factors",
    "Automated SMS reminders to patient"
  ],
  "Low": [
    "Standard discharge education",
    "PCP follow-up in 2–4 weeks",
    "Self-monitoring log (BP/BG/Weight)"
  ]
};


  function showRecommendations(riskLevel) {
    const section = document.getElementById('recommendations-section');
    const list = document.getElementById('recommendations-list');
    list.innerHTML = '';
    if (MEASURES[riskLevel]) {
      MEASURES[riskLevel].forEach(item => {
        const li = document.createElement('li');
        li.className = 'list-group-item';
        li.textContent = item;
        list.appendChild(li);
      });
      section.style.display = 'block';
    }
  }

  // ✅ Automatically show recommendations after prediction
  document.addEventListener('DOMContentLoaded', function () {
    {% if prediction %}
      showRecommendations("{{ prediction }}");
    {% endif %}
  });
</script>
{% endblock %}
